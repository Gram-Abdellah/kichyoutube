import os
import json
import yt_dlp
from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload

# --- SHOW DATABASE ---
SHOWS = {
    "1": {
        "name": "ุจูุงุช ูุงูุฉ ููุงูุฉ ุงูุฌุฒุก 3 - ุฑูุถุงู 2026",
        # ุชู ุชุตุญูุญ {ep} ููุง ูุชุชูุงูู ูุน ุงูู format ุจุงูุฃุณูู
        "title_template": "ุจูุงุช ูุงูุฉ ููุงูุฉ ุงูุฌุฒุก 3 ุงูุญููุฉ {ep} ุฑูุถุงู 2026",
        "description": """ุงูุนูุฏุฉ ุงูููุชุธุฑุฉ! ๐ ุจุนุฏ ุบูุงุจ 12 ุณูุฉุ "ุจูุงุช ูุงูุฉ ููุงูุฉ" ููุฑุฌุนูุง ููุฏููุฉ ุดูุดุงูู ุงูุณุงุญุฑุฉ.. ููู ูุงุฏ ุงููุฑุฉ ุงูุตุฑุงุนุงุช ูุงูููุงุฌุขุช ุบุงุฏูุฉ ุชููู ุฃููู ูู ูุจู! ๐ฅโก๏ธ
ูุง ุชููุชูุง ููุนุฏ ุงูููุงุก ูุน ููุงูุฉ ูุจูุงุชูุง.
๐ ููููุงู ูู ุฑูุถุงู
โฐ ุนูู ุงูุณุงุนุฉ 18:40
๐บ ุนูู ููุงุฉ 2M""",
        "keywords": "ุจูุงุช ูุงูุฉ ููุงูุฉ ุงูุฌุฒุก ุงูุซุงูุซ, ูุณูุณูุงุช ุฑูุถุงู 2026 ุงููุบุฑุจูุฉ, ุฌุฏูุฏ ุฏุฑุงูุง ุฑูุถุงู ุนูู 2M, ูุตุฉ ุจูุงุช ูุงูุฉ ููุงูุฉ ูู ุดูุดุงูู, ุฃุจุทุงู ูุณูุณู ุจูุงุช ูุงูุฉ ููุงูุฉ, ููุนุฏ ุนุฑุถ ูุณูุณู ุจูุงุช ูุงูุฉ ููุงูุฉ, ุงูุฏุฑุงูุง ุงููุบุฑุจูุฉ 2026",
        "thumb_folder": "thumbnails/bnatlalamenan"
    },
    "2": {
        "name": "ูุณูุณู ูุฑููุฉ ู ุจูุงุชูุง - Karima d Istis",
        "title_template": "Karima d Istis - Episode {ep} | ูุณูุณู ูุฑููุฉ ู ุจูุงุชูุง - ุงูุญููุฉ {ep} | โดฝโดฐโตโตโตโดฐ โดท โตโตโตโตโต",
        "description": """ุฏุฑุงูุง ุงุฌุชูุงุนูุฉ ุฃูุงุฒูุบูุฉ ุจุงูุชูุงุฒ! โ๏ธโจ 
ุดุงูุฏูุง ูุณูุณู "ูุฑููุฉ ู ุจูุงุชูุง" (Karima d Istis)ุ ุงูุนูู ุงูุฐู ูุบูุต ูู ุนูู ุงููุฌุชูุน ุงูุฃูุงุฒูุบู ููุนูุณ ุตุฑุงุนุงุช ููููุฉ ูููู ุฅูุณุงููุฉ ุฎุงูุฏุฉ. 
ุจูู ุนุจู ุงููููุฉ ูุชุญุฏูุงุช ุงูุนุตุฑุ ุชููููุง ูุฑููุฉ ูู ุฑุญูุฉ ุฏุฑุงููุฉ ูุดููุฉ ุนุจุฑ ููุงุฉ ุชูุงุฒูุบุช.

๐น ุงููุตุฉ: ุตุฑุงุนุงุชุ ุชุญุฏูุงุชุ ูุฃูู ูุชุฌุฏุฏ ูู ููุจ ุงููููุฉ ุงูุฃูุงุฒูุบูุฉ.
๐ ููููุงู ุฎูุงู ุดูุฑ ุฑูุถุงู ุงููุจุงุฑู.
๐ ูุง ุชูุณูุง ุงูุงุดุชุฑุงู ูู ุงูููุงุฉ ูุชูุนูู ุงูุฌุฑุณ ููุตููู ูู ุฌุฏูุฏ!""",
        "keywords": "ูุฑููุฉ ูุจูุงุชูุง, Karima d Istis, โดฝโดฐโตโตโตโดฐ โดท โตโตโตโตโต, ูุณูุณู ุฃูุงุฒูุบู 2026, ููุงุฉ ุชูุงุฒูุบุช, ุฏุฑุงูุง ุฃูุงุฒูุบูุฉ, ุฑูุถุงู 2026 ุงููุบุฑุจ, ูุณูุณูุงุช ุชูุงุฒูุบุช, ุงูุซูุงูุฉ ุงูุฃูุงุฒูุบูุฉ, Tamazight TV, Drama Amazigh",
        "thumb_folder": "thumbnails/karima_istis"
    },
    "3": {
        "name": "ุญูุงูุงุช ุดุงูุฉ - Hikayat Chama",
        "title_template": "ุญูุงูุงุช ุดุงูุฉ - ุงูุญููุฉ {ep} | Hikayat Chama - Episode {ep}",
        "description": """ุญูู ุชุตุจุญ "ุงูุญูุงูุฉ" ูู ุงูุณูุงุญ ุงููุญูุฏ ูููุงุฌูุฉ ูุณูุฉ ุงููุงูุน.. ๐โจ
ูุนูุด ูุน "ุดุงูุฉ" ุฑุญูุฉ ุงุณุชุซูุงุฆูุฉ ุชุณุชุญุถุฑ ูููุง ุณุญุฑ ุงูููุฑูุซ ุงูุซูุงูู ุงููุบุฑุจู ูุงูุญูุงูุงุช ุงูุดุนุจูุฉ ูุชูุชุตุฑ ุนูู ุงูุธูู. ๐ฅโก๏ธ
ุฏุฑุงูุง ูุดููุฉ ุชูุฒุฌ ุจูู ุงูุฃุตุงูุฉ ูุงููุงูุน ูู ูุงูุจ ููู ูุฑูุฏ ูุนูุฏ ุงูุงุนุชุจุงุฑ ููุชุฑุงุซ ุงูุดููู ุงููุบุฑุจู.

๐ ููุนุฏูู ููููุงู ูู ุฑูุถุงู
โฐ ุนูู ุงูุณุงุนุฉ 19:25 (07:25 ูุณุงุกู)
๐ ุงุดุชุฑููุง ุงูุขู ููุนููุง ุงูุฌุฑุณ ููุชุงุจุนุฉ ุญููุงุช "ุญูุงูุงุช ุดุงูุฉ" ุฃููุงู ุจุฃูู!""",
        "keywords": "ุญูุงูุงุช ุดุงูุฉ, Hikayat Chama, ูุณูุณูุงุช ุฑูุถุงู 2026 ุงููุบุฑุจูุฉ, ุงูุญูุงูุฉ ุงูุดุนุจูุฉ ุงููุบุฑุจูุฉ, ุงูุชุฑุงุซ ุงููุบุฑุจู, ุฏุฑุงูุง ูุบุฑุจูุฉ, ุดุงูุฉ ุฑูุถุงู 2026, ุงูููุฑูุซ ุงูุซูุงูู, ุญูุงูุงุช ูุบุฑุจูุฉ ูุฏููุฉ",
        "thumb_folder": "thumbnails/hikayat_chama"
    },
    "4": {
        "name": "ูุณูุณู ุนุด ุงูุทูุน - Aach Tmaa",
        "title_template": "Aach Tmaa - Episode {} | ูุณูุณู ุนุด ุงูุทูุน - ุงูุญููุฉ {} | ุฃุฎุทุฑ ูุถูุฉ ุงุฌุชูุงุนูุฉ: ุงูุฅุชุฌุงุฑ ูู ุงูุฑุถุน",
        "description": """ุงูุตุฏูุฉ.. ุญูู ูุชุญูู "ุนุด ุงูุทูุน" ุฅูู ุฌุญูู ูุชุงุฌุฑ ุจุงูุจุฑุงุกุฉ! ๐ฅ๐ถ
ุดุงูุฏูุง ุงูุญููุฉ {} ูู ูุณูุณู "ุนุด ุงูุทูุน"ุ ุงูุฏุฑุงูุง ุงูุงุฌุชูุงุนูุฉ ุงูุฃูุซุฑ ุฌุฑุฃุฉ ูู ุฑูุถุงู 2026. 

ุชุฌูุน ุงูุญูุงูุงุช ูุณุงุกู ูู ุฎูููุงุช ูุฎุชููุฉุ ููู ุงููุตูุฑ ูุงุญุฏ ูู ููุงุฌูุฉ ุฃุฎุทุฑ ุงููุถุงูุง ุงูุงุฌุชูุงุนูุฉ: ุงูุฅุชุฌุงุฑ ูู ุงูุฑุถุน. ููู ุณุชููุฏูู ุงูุฃูุฏุงุฑ ุฏุงุฎู "ุนุด ุงูุทูุน"ุ ๐๏ธโก๏ธ

๐ ููุนุฏ ุงูุนุฑุถ: ููููุงู ูู ุฑูุถุงู ๐
โฐ ุงูุชูููุช: ุนูู ุงูุณุงุนุฉ 19:30 ูุณุงุกู
๐บ ุงูููุงุฉ: ุงูุฃููู (Al Aoula)

โ๏ธ ุงููุณูุณู ูุณูุท ุงูุถูุก ุนูู ูุงูุน ูุฑูุฑ ููุถุงูุง ุฅูุณุงููุฉ ุญุณุงุณุฉ.
๐ ุงุดุชุฑู ุงูุขู ููุนู ุงูุฌุฑุณ ููุชุงุจุนุฉ ุฃููู ุงููุณูุณูุงุช ุงููุบุฑุจูุฉ ูุฑูุถุงู 2026!""",
        "keywords": "ุนุด ุงูุทูุน, Aach Tmaa, ูุณูุณู ุนุด ุงูุทูุน ุงูุญููุฉ 1, ุงูุฅุชุฌุงุฑ ูู ุงูุฑุถุน, ูุถุงูุง ุงุฌุชูุงุนูุฉ ูุบุฑุจูุฉ, ูุณูุณูุงุช ุฑูุถุงู 2026 ุงููุบุฑุจูุฉ, ููุงุฉ ุงูุฃููู ุงููุบุฑุจูุฉ, Al Aoula TV, ุจูุน ุงูุฑุถุน, ุฏุฑุงูุง ูุบุฑุจูุฉ ูุงูุนูุฉ, ุฌุฏูุฏ ูุณูุณูุงุช ุฑูุถุงู ุงููุบุฑุจ, ูุณูุณู ูุบุฑุจู 2026",
        "thumb_folder": "thumbnails/aach_tmaa_ep1"
    },
    "5": {
        "name": "ูุณูุณู ุดููู ูุงู ูููู - Chkoune Kane Igoul",
        "title_template": "Chkoune Kane Igoul - Episode {} | ูุณูุณู ุดููู ูุงู ูููู - ุงูุญููุฉ {} | ุฃุณุฑุงุฑ ูุตุฏูุงุช ุบูุฑ ูุชููุนุฉ",
        "description": """ุดููู ูุงู ูููู ุจูู ุงูุญูุงุฉ ุชูุฏุฑ ุชุชุจุฏู ูู ุฑูุดุฉ ุนููุ ๐ฑโจ 
ุดุงูุฏูุง ุงูุญููุฉ {} ูู ูุณูุณู "ุดููู ูุงู ูููู"ุ ุงูุนูู ุงูุฏุฑุงูู ุงูุฐู ูุบูุต ูู ุฃุนูุงู ุงูููุณ ุงูุจุดุฑูุฉ ูููุดู ุงููุณุชูุฑ.

ุจูู ุงููุงุถู ูุงูุญุงุถุฑุ ุชููุดู ุญูุงุฆู ูุฏูููุฉ ูุฃููุนุฉ ูู ููู ูุชุฎูููุง. ูู ุฃูุชู ูุณุชุนุฏูู ูุฑุญูุฉ ูู ุงูุบููุถ ูุงูุชุดููู ุงูุชู ุณุชุบูุฑ ูู ุชููุนุงุชููุ ๐ต๏ธโโ๏ธ๐ฅ

๐ ููุนุฏูู ููููุงู ูู ุฑูุถุงู ๐
โฐ ุงูุชูููุช: ุนูู ุงูุณุงุนุฉ 20:30 ูุณุงุกู (ุจุนุฏ ุตูุงุฉ ุงูุชุฑุงููุญ)
๐บ ุงูููุงุฉ: ุงูุฃููู (Al Aoula)

๐ ุงุดุชุฑู ุงูุขู ููุนู ุงูุฌุฑุณ ููุชุงุจุนุฉ ุฃููู ูุญุธุงุช "ุดููู ูุงู ูููู" ุทููุฉ ุดูุฑ ุฑูุถุงู ุงููุจุงุฑู!""",
        "keywords": "ุดููู ูุงู ูููู, Chkoune Kane Igoul, ูุณูุณู ุดููู ูุงู ูููู ุงูุญููุฉ 1, ุฏุฑุงูุง ูุบุฑุจูุฉ 2026, ูุณูุณูุงุช ุฑูุถุงู 2026 ุงููุบุฑุจูุฉ, ููุงุฉ ุงูุฃููู ุงููุบุฑุจูุฉ, Al Aoula TV, ุบููุถ ูุชุดููู ูุบุฑุจู, ุฌุฏูุฏ ุงูุฏุฑุงูุง ุงููุบุฑุจูุฉ, ุฃุณุฑุงุฑ ูุญูุงุฆู, ุฑูุถุงู 2026 ุงููุบุฑุจ",
        "thumb_folder": "thumbnails/chkoune_kane_igoul_ep1"
    }
}


def get_service(api_name, api_version):
    token_json = os.getenv('GOOGLE_TOKEN')
    if token_json:
        creds = Credentials.from_authorized_user_info(json.loads(token_json))
    else:
        # ุชุฃูุฏ ุฃู ููู token.json ููุฌูุฏ ูู ููุณ ุงููุฌูุฏ ุนูุฏ ุงูุชุฌุฑุจุฉ ุงููุญููุฉ
        with open('token.json', 'r') as f:
            creds = Credentials.from_authorized_user_info(json.load(f))
    return build(api_name, api_version, credentials=creds)

def process_video(show_id, ep_num, video_url):
    show = SHOWS.get(show_id)
    if not show:
        return "โ Show ID not found."

    # ุชุฌููุฒ ุงููุตูุต
    final_title = show["title_template"].format(ep=ep_num)
    
    # ุชุฃูุฏ ูู ุงูุชุฏุงุฏ ุงูุตูุฑุฉ (png ุฃู jpg)
    final_thumb = f"{show['thumb_folder']}/{ep_num}.png" 
    
    # ุงุณุชุฎุฏุงู ุงุณู ููู ุจุณูุท ูุชุฌูุจ ูุดุงูู ุงููุบุฉ ุงูุนุฑุจูุฉ ูู ุงููุณุงุฑุงุช
    video_file = "temp_video.mp4"

    # 1. ุชุญููู ุงูููุฏูู
    print(f"๐ฅ Downloading {final_title}...")
    ydl_opts = {
        'outtmpl': video_file, 
        'format': 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best'
    }
    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        ydl.download([video_url])

    # 2. ุงูุฑูุน ุฅูู Google Drive
    #print(f"โ๏ธ Uploading to Drive...")
    #drive_service = get_service('drive', 'v3')
    #drive_meta = {'name': f"{final_title}.mp4"}
    #media_drive = MediaFileUpload(video_file, mimetype='video/mp4', resumable=True)
    #drive_file = drive_service.files().create(body=drive_meta, media_body=media_drive).execute()
    #print(f"โ Drive Upload Done: {drive_file.get('id')}")

    # 3. ุงูุฑูุน ุฅูู YouTube
    '''
    print(f"๐บ Uploading to YouTube...")
    yt_service = get_service('youtube', 'v3')
    yt_body = {
        'snippet': {
            'title': final_title,
            'description': show['description'],
            'tags': [t.strip() for t in show['keywords'].split(',')],
            'categoryId': '22'
        },
        'status': {'privacyStatus': 'private'}
    }
    
    media_yt = MediaFileUpload(video_file, chunksize=-1, resumable=True)
    insert_req = yt_service.videos().insert(
        part='snippet,status',
        body=yt_body,
        media_body=media_yt
    )
    yt_res = insert_req.execute()
    video_id = yt_res['id']
    print(f"โ YouTube Upload Done: {video_id}")

    # 4. ุฑูุน ุงูุตูุฑุฉ ุงููุตุบุฑุฉ (Thumbnail)
    if os.path.exists(final_thumb):
        yt_service.thumbnails().set(
            videoId=video_id,
            media_body=MediaFileUpload(final_thumb)
        ).execute()
        print("โ Thumbnail Uploaded.")
    else:
        print(f"โ๏ธ Thumbnail not found at: {final_thumb}")

    # ุชูุธูู: ุญุฐู ุงูููู ุงููุคูุช ุจุนุฏ ุงูุฑูุน
    if os.path.exists(video_file):
        os.remove(video_file)
    
    return f"Done! {final_title} is live (private)."
'''
